{% extends 'layout.html' %}
{% import "macro.html" as macro %}
{% import "components/table.html" as _table with context %}
{% block title %}{{ macro.display_name(model_name) }}{% endblock %}
{% block body %}
  <div class="row">
    <div class="col">
      <h4 id="title">{{ macro.icon(model_name) }} {% trans %}List of{% endtrans %} {{ macro.display_name(model_name) }}</h4>
    </div>
    <div class="col text-end mb-2">
      {% if has_new %}
        <a class="btn btn-primary {% if not new_perm %}disabled{% endif %}"
           href="{{ url_for(model, 'new') }}"
           role="button"
           {% if not new_perm %}aria-disabled="true" title="{% trans %}Permissions required{% endtrans %}"{% endif %}>
          {% trans %}Create{% endtrans %}
        {{ macro.display_name(model_name) }}</a>
      {% endif %}
    </div>
  </div>
  {% include "flash.html" %}
  {# Define a default columns list from form #}
  {% set ns = namespace(default_columns=[]) %}
  {% set buttons = [] %}
  {% for field in form %}
    {% if field.widget['input_type'] != 'hidden' %}
      {% set ns.default_columns = ns.default_columns + [{'name': field.name, 'title': field.label.text|string, 'orderable':True, 'render': 'summary' if loop.first else 'text'}] %}
    {% endif %}
  {% endfor %}
  {% set table_columns = columns|d(ns.default_columns) %}
  {# Append Action columns #}
  {% set table_columns = table_columns + [{'name':'url', 'title':'', 'orderable':False, 'render':'action', 'width': '30px'}] %}
  {# Add Status Filter if status column exists #}
  {% if 'status' in (table_columns|map(attribute='name')|list) %}
    {% set buttons = buttons + [{'text': _('Show Deleted'), 'extend': 'filter', 'column': 'status:name', 'search':'(enabled|disabled|deleted)', 'search_off': '(enabled|disabled)', 'regex': True, 'className': 'udb-btn-filter' }] %}
  {% endif %}
  {# Add Owner filter if owner column exists #}
  {% if 'owner' in (table_columns|map(attribute='name')|list) %}
    {% set buttons = buttons + [{'text': _('Owned by me'), 'extend': 'filter', 'column': 'owner:name', 'search': currentuser.summary, 'className': 'udb-btn-filter'}] %}
  {% endif %}
  {% set buttons = buttons + extra_buttons|d([]) %}
  {# Add "Clear" filter #}
  {% set buttons = buttons + [{'text': _('Clear'), 'extend': 'clear'}] %}
  {# Add "More" button collection #}
  {% set download_filename = _('export_') + macro.display_name(model_name)|lower %}
  {% set csv_button = {'text': _('Download Csv'), 'extend': 'csv', 'exportOptions': {'columns': '.export'}, 'title': download_filename, 'className':'udb-btn-download text-nowrap' } %}
  {% set xsl_button = {'text': _('Download Excel'), 'extend': 'excel', 'exportOptions': {'columns': '.export'}, 'title': download_filename, 'className':'udb-btn-download text-nowrap' } %}
  {% set pdf_button = {'text': _('Download PDF'), 'extend': 'pdf', 'exportOptions': {'columns': '.export'}, 'title': download_filename, 'className':'udb-btn-download text-nowrap', 'orientation':'landscape' } %}
  {% set more_button = {'text': _('More'), 'extend': 'collection', 'align':'button-right', 'autoClose':True, 'background': False, 'popoverTitle': _('More'), 'buttons': [ csv_button, xsl_button, pdf_button], 'className':'udb-btn-more-menu' } %}
  {% set buttons = buttons + [more_button] %}
  {# Show default table #}
  {{ _table.table(data="data.json", columns=table_columns, buttons=buttons) }}
{% endblock body %}
